<!doctype html>
<html lang="uk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–ü–æ–¥—ñ—ó ‚Äî –æ–¥–∏–Ω —Ñ–∞–π–ª (–≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ)</title>
    <style>
        :root{
            --bg: var(--tg-theme-bg-color, #fff);
            --fg: var(--tg-theme-text-color, #111);
            --muted: color-mix(in oklab, var(--fg), #999 55%);
            --card: color-mix(in oklab, var(--bg), #000 4%);
            --border: color-mix(in oklab, var(--fg), #000 80%);
            --accent: var(--tg-theme-button-color, #2a85ff);
            --accent-fg: var(--tg-theme-button-text-color, #fff);
        }
        *{ box-sizing: border-box; }
        html,body{ height:100%; }
        body{
            margin:0; background:var(--bg); color:var(--fg);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
            display:flex; justify-content:center; align-items:stretch;
        }
        .app{ width:min(720px,100%); min-height:100dvh; padding:10px; display:flex; flex-direction:column; gap:10px; }
        header{ display:flex; align-items:center; justify-content:space-between; }
        header h1{ margin:0; font-size:18px; }
        .hint{ color:var(--muted); font-size:12px; }

        ul.events{ list-style:none; margin:0; padding:0; display:grid; gap:10px; }
        li.event{ background:var(--card); border:1px solid color-mix(in oklab, var(--border), var(--bg) 70%); border-radius:12px; overflow:clip; }

        summary{
            list-style:none; cursor:pointer;
            display:grid; gap:10px; padding:10px 12px;
            grid-template-columns: auto 1fr auto; /* –¥–∞—Ç–∞ | –±—Ä—ñ—Ñ | –¥—ñ—ó */
            align-items:start;
        }
        summary::-webkit-details-marker{ display:none; }

        .date{
            display:inline-flex; gap:6px; align-items:center;
            padding:4px 8px; border:1px dashed color-mix(in oklab, var(--border), var(--bg) 60%);
            border-radius:999px; font-size:12px; white-space:nowrap;
        }
        .weekday{
            padding:2px 6px; border:1px dashed color-mix(in oklab, var(--border), var(--bg) 60%);
            border-radius:999px; font-size:12px; text-transform:lowercase;
        }
        .dot{ opacity:.5; }

        .brief{
            white-space: normal;       /* –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤–Ω—ñ—Å—Ç—é */
            overflow: visible;
            min-width: 0;
            line-height: 1.3;
        }

        .actions{ display:flex; align-items:center; gap:8px; justify-self:end; }
        .vote-btn{
            appearance:none; border:0; border-radius:999px; padding:6px 10px;
            background:var(--accent); color:var(--accent-fg); font-size:14px; cursor:pointer;
        }
        .vote-btn[aria-pressed="true"]{ outline:2px solid color-mix(in oklab, var(--accent), #000 30%); }
        .count{ font-variant-numeric: tabular-nums; font-size:13px; }
        .chev{ margin-left:6px; font-size:16px; opacity:.6; transition:transform .2s ease; }
        details[open] .chev{ transform:rotate(90deg); }

        .panel{ padding:12px; border-top:1px solid color-mix(in oklab, var(--border), var(--bg) 70%); display:grid; gap:10px; }
        .fulltext{ line-height:1.35; }

        @media (max-width: 380px){
            summary{
                grid-template-columns: auto 1fr; /* –¥–∞—Ç–∞ | –±—Ä—ñ—Ñ */
                grid-auto-rows: auto;
            }
            .actions{ justify-self:start; } /* –¥—ñ—ó –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—å—Å—è —Ç—Ä–µ—Ç—ñ–º —Ä—è–¥–∫–æ–º */
        }

        @media (hover:hover){ summary:hover{ background: color-mix(in oklab, var(--card), #000 6%);} }
    </style>
    <!-- –£ Mini App —Å–∫—Ä–∏–ø—Ç –∑–∞–∑–≤–∏—á–∞–π —É–∂–µ —î; –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Ç—É—Ç –Ω–µ –∑–∞–≤–∞–¥–∏—Ç—å -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<main class="app">
    <header>
        <h1>–ü–æ–¥—ñ—ó</h1>
        <div class="hint">–ö–ª—ñ–∫ –ø–æ —Ä—è–¥–∫—É ‚Äî –¥–µ—Ç–∞–ª—ñ. –ö–Ω–æ–ø–∫–∞ ‚Äî –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è.</div>
    </header>
    <ul class="events" id="list"></ul>
</main>

<script type="module">
    const host = 'http://localhost:8888/'
    import DATA from './events.js';
    import ky from 'https://esm.sh/ky@^1';
    const polldata = await ky.get(host+'.netlify/functions/getpoll').json();
    console.log(polldata)

    const $ = (sel, root=document) => root.querySelector(sel);

    // –ë–µ–∑–ø–µ—á–Ω–∏–π –ø–∞—Ä—Å–µ—Ä ¬´YYYY-MM-DD¬ª ‚Üí –ª–æ–∫–∞–ª—å–Ω–∏–π Date (–±–µ–∑ UTC-–∑—Å—É–≤—É)
    function parseISODateLocal(iso){
        const [y, m, d] = iso.split('-').map(Number);
        return new Date(y, (m||1)-1, d||1);
    }

    function fmtDateBits(iso){
        const d = parseISODateLocal(iso);
        const weekday = new Intl.DateTimeFormat('uk-UA', { weekday: 'short' }).format(d); // –ø–Ω..–Ω–¥
        const date = new Intl.DateTimeFormat('uk-UA', { day: 'numeric', month: 'long' }).format(d); // 12 –∂–æ–≤—Ç–Ω—è
        return { weekday, date };
    }

    // –õ–æ–∫–∞–ª—å–Ω—ñ ¬´–≥–æ–ª–æ—Å–∏¬ª (–±–µ–∑ –±–µ–∫–µ–Ω–¥—É)
    const LS_KEY = 'event_votes_v6';
    const votes = new Map(Object.entries(JSON.parse(localStorage.getItem(LS_KEY) || '{}'))); // id -> {count, voters:[]}
    const rvotes = polldata.poll;

    const userid = (() => {
        try {
            const tg = window.Telegram?.WebApp;
            if (tg?.initDataUnsafe?.user?.id) return `tg:${tg.initDataUnsafe.user.id}`;
        } catch {}
        return 1234;
    })();
    const persist = () => {
        const obj = {};
        for (const [id,v] of votes) obj[id] = { count: v.count||0, voters: v.voters||[] };
        localStorage.setItem(LS_KEY, JSON.stringify(obj));
    };

    // ====== –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫—É (–∑ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è–º –∑–∞ –¥–∞—Ç–æ—é) ======
    const list = $('#list');
    list.innerHTML = '';

    const sorted = [...DATA].sort((a,b) => parseISODateLocal(a.event_date) - parseISODateLocal(b.event_date));
    let voted = polldata.voted?.includes(userid);

    for (const ev of sorted){
        let st;
        try {st = rvotes[ev.id]} catch (e) {st=0}
         //votes.get(String(ev.id)) || { count:0, voters:[] };

        const { weekday, date } = fmtDateBits(ev.event_date);

        const li = document.createElement('li');
        li.className = 'event';
        li.innerHTML = `
      <details data-id="${ev.id}" name="events">
        <summary>
          <span class="date" aria-label="–î–∞—Ç–∞ –ø–æ–¥—ñ—ó">
            <span class="weekday" aria-label="–î–µ–Ω—å —Ç–∏–∂–Ω—è">${weekday}</span>
            <span class="dot" aria-hidden="true">‚Ä¢</span>
            <time datetime="${ev.event_date}">${date}</time>
          </span>
          <span class="brief">${ev.brief}</span>
          <span class="actions">
            <button class="vote-btn" type="button" aria-pressed="${voted ? 'true':'false'}" aria-label="–ì–æ–ª–æ—Å—É–≤–∞—Ç–∏ –∑–∞ –ø–æ–¥—ñ—é ${date} (${weekday})">üëç</button>
            <span class="count" aria-live="polite" aria-atomic="true"><strong>${st||0}</strong></span>
            <span class="chev" aria-hidden="true">‚Ä∫</span>
          </span>
        </summary>
        <div class="panel">
          <div class="fulltext">${ev.fulltext}</div>
        </div>
      </details>
    `;
        list.append(li);
    }

    // ====== –ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –≤ summary (–Ω–µ –≤—ñ–¥–∫—Ä–∏–≤–∞—î details) ======
    list.addEventListener('click', async (e) => {
        const btn = e.target.closest('.vote-btn');
        //if (!btn || polldata.voted.includes(userid)) return;
        e.stopPropagation();
        e.preventDefault();

        const details = e.target.closest('details');
        const issueid = String(details.dataset.id);
        let curvotes = polldata.poll[issueid] || 0

        console.log(`voting for ${issueid} from ${userid} now ${curvotes}`);
        if (voted) return
        const voterez = await ky.get(host+'.netlify/functions/sendvoice',
            {
                searchParams: {issueid,userid,q: 'kyiv'}
            })
            .json();
        curvotes++;
        voted = true
        details.querySelector('.count strong').textContent = String(curvotes);


        // let v = votes.get(issueid);
        // if (!v) v = { count:0, voters:[] };
        // const i = v.voters.indexOf(userid);
        // if (i === -1){
        //     v.voters.push(userid);
        //     v.count++;
        //     btn.setAttribute('aria-pressed','true');
        // } else {
        //     v.voters.splice(i,1);
        //     v.count = Math.max(0,(v.count||0)-1);
        //     btn.setAttribute('aria-pressed','false');
        // }
        // votes.set(issueid, v);
        // persist();
        // details.querySelector('.count strong').textContent = String(v.count||0);
        //
    });

    // –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –Ω–µ ¬´—Å–º–∏–∫–∞—î¬ª summary –ø—ñ–¥ —á–∞—Å –Ω–∞—Ç–∏—Å–∫–∞–Ω—å –Ω–∞ –∫–Ω–æ–ø–∫—É
    list.addEventListener('keydown', (e) => {
        if (e.target.closest('.vote-btn')) e.stopPropagation();
    });

    // –§–æ–ª–±–µ–∫, —è–∫—â–æ name —É <details> –Ω–µ –ø—Ä–∞—Ü—é—î: –≤ —Ä–∞–∑—ñ –ø–æ—Ç—Ä–µ–±–∏ ‚Äî –∑–∞–∫—Ä–∏–≤–∞—Ç–∏–º–µ–º–æ —Å—É—Å—ñ–¥—ñ–≤ –≤—Ä—É—á–Ω—É
    (function fallbackIfNoNameSupport(){
        const a = document.createElement('details'); a.setAttribute('name','events');
        const b = document.createElement('details'); b.setAttribute('name','events');
        document.body.append(a,b); a.open = true; b.open = true;
        const supported = !(a.open && b.open);
        a.remove(); b.remove();
        if (supported) return;
        list.addEventListener('toggle', (e) => {
            const d = e.target;
            if (d.tagName !== 'DETAILS' || !d.open) return;
            const name = d.getAttribute('name');
            if (!name) return;
            for (const other of list.querySelectorAll(`details[name="${CSS.escape(name)}"]`)){
                if (other !== d && other.open) other.open = false;
            }
        });
    })();

    // –†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –≤–µ–±-–¥–æ–¥–∞—Ç–æ–∫ —É Telegram (—è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–æ)
    try { window.Telegram?.WebApp?.expand?.(); } catch {}
</script>
</body>
</html>
