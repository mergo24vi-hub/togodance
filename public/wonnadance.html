<!doctype html>
<html lang="uk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>wonna dance — мапа</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        :root { --vh: 100svh; } /* реальне значення поставить miniapp-layout.js */
        html, body {
            height: 100%;
            margin: 0;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #111);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
        }
        #map { height: var(--vh); width: 100%; }

        /* Стиль завжди видимого підпису біля маркера */
        .leaflet-tooltip.party-label {
            pointer-events: none;           /* щоб не заважав кліку по маркеру */
            background: rgba(255,255,255,.9);
            border: 1px solid rgba(0,0,0,.15);
            border-radius: 6px;
            padding: 2px 6px;
            font-size: 13px;
            color: #111;
            box-shadow: 0 1px 2px rgba(0,0,0,.1);
            white-space: nowrap;
        }
        .leaflet-container { background: var(--tg-theme-bg-color, #fff); }

        .vote-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(255,255,255,.95);
            border: 1px solid rgba(0,0,0,.15);
            box-shadow: 0 1px 2px rgba(0,0,0,.1);
            font: 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            user-select: none;
            white-space: nowrap;
        }
        .vote-badge button {
            border: none;
            background: #1976d2;
            color: #fff;
            padding: 4px 8px;
            border-radius: 999px;
            font: inherit;
            cursor: pointer;
        }
        .vote-badge button[disabled] {
            background: #9e9e9e;
            cursor: default;
            opacity: .75;
        }
    </style>
</head>
<body>
<div id="map" aria-label="Мапа вечірок Києва"></div>
<div id="comment-box" style="display:none; position:absolute; top:10px; left:50%; transform:translateX(-50%);
background:white; padding:8px; border:1px solid #ccc; z-index:2000;">
    <input type="text" id="rect-comment" placeholder="Введіть коментар"/>
    <button id="save-comment">Зберегти</button>
</div>

<!-- (необов'язково) Telegram SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<!-- Лише логіка рендерингу карти -->
<script type="module">
    import { attachMapInvalidate } from './miniapp-layout.js';


    // 2) Утиліта для безпечного HTML у попапі
    function escapeHtml(s='') {
        return s
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // 3) Базова мапа
    const KYIV = [50.4501, 30.5234];
    const map = L.map('map', {
        center: KYIV,
        zoom: 12,
        zoomControl: true,
        attributionControl: true
    });

    // OSM тайли (обов'язкова атрибуція)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);


    // drawnItems/Control - дві групи
    const existingRects = L.layerGroup().addTo(map);   // тільки «чужі/готові» прямокутники
    const userRectGroup = new L.FeatureGroup().addTo(map); // тільки один «користувацький»

    const drawControl = new L.Control.Draw({
        draw: {
            polygon: false,
            polyline: false,
            circle: false,
            marker: false,
            circlemarker: false,
            rectangle: {
                shapeOptions: {color: '#3388ff', weight: 2}
            }
        },
        edit: {
            featureGroup: userRectGroup,
            remove: true
        }
    });
    map.addControl(drawControl);

    const allBounds = [];

    const items = getRects()

    for (const item of items){ //
        const rect = L.rectangle(item.rectangle, { color: '#3388ff', weight: 2 })
            .addTo(existingRects);
        rect._id = item.id;
        // Безпечний tooltip (DOM node)
        rect.bindTooltip((item.comment || ''), {
            permanent: true,
            direction: 'bottom',
            className: 'rect-comment-tooltip'
        });

        const baseStyle  = { color: '#3388ff', weight: 2, fillOpacity: 0.15, interactive: true };
        const hoverStyle = { weight: 3, fillOpacity: 0.3 };

        rect
            .on('click', (e) => {
                console.log('rect clicked '+rect._id)
            })
            .on('mouseover', (e) => {
                console.log('rect overed '+rect._id)
                e.target.setStyle(hoverStyle).bringToFront();
            })
            .on('mouseout', (e) => {
                console.log('rect out '+rect._id)
                e.target.setStyle(baseStyle);
            })

    }

    // 3) Підігнати карту під усі прямокутники (один виклик ПІСЛЯ циклу)
    if (items.length) {
        const bounds = existingRects.getBounds();
        if (bounds.isValid()) {
            map.fitBounds(bounds, {
                padding: [20, 20], // трохи відступів від країв
                maxZoom: 16,       // не занадто наближати
                animate: true
            });
        }
    }

    map.on(L.Draw.Event.CREATED, ({ layer }) => {
        userRectGroup.clearLayers().addLayer(layer);

        if (!(layer instanceof L.Rectangle)) return;

        console.log('Прямокутник координати:', layer.getBounds().toBBoxString());
        const b = layer.getBounds();
        console.log(rectId(b))
        const arrayFormat = [
            [b.getSouth(), b.getWest()],
            [b.getNorth(), b.getEast()]
        ];
        console.log(arrayFormat);

        const box = document.getElementById('comment-box');
        const btn = document.getElementById('save-comment');
        const input = document.getElementById('rect-comment');

        box.style.display = 'block';

        // додаємо слухача один раз (once: true) — не накопичуємо обробники
        btn.addEventListener('click', function saveRectCommentHandler() {
            const text = input.value.trim();
            box.style.display = 'none';
            input.value = '';

            if (!text) return;

            // Безпечний контент: передаємо DOM-елемент (щоб уникнути ін'єкцій HTML)
            const textNode = document.createTextNode(text);
            layer.bindTooltip(textNode, {
                permanent: true,
                direction: 'bottom',
                className: 'rect-comment-tooltip'
            }).openTooltip();

            console.log('Додано коментар:', text);
        }, { once: true });
    });

    attachMapInvalidate(map); // акуратна реакція на ресайз/старт

    function rectId(bounds) {
        const b = bounds;
        const s = [
            b.getSouthWest().lat.toFixed(6), b.getSouthWest().lng.toFixed(6),
            b.getNorthEast().lat.toFixed(6), b.getNorthEast().lng.toFixed(6)
        ].join(',');

        // djb2 (32-bit)
        let h = 5381;
        for (let i = 0; i < s.length; i++) {
            h = ((h << 5) + h) + s.charCodeAt(i); // h*33 + c
        }
        // беззнакове 32-бітове число
        let n = h >>> 0;

        // у base36 найкоротше представлення
        let id = n.toString(36);

        // детерміноване доповнення до 10 символів простим змішуванням
        while (id.length < 10) {
            n = (n * 2654435761) >>> 0; // "золоте" множення для міксу
            id += n.toString(36);
        }
        return id.slice(0, 10);
    }

    function eastEdgeCenter(bounds) {
        const ne = bounds.getNorthEast();
        const se = bounds.getSouthEast();
        const lat = (ne.lat + se.lat) / 2;
        const lng = ne.lng;
        return L.latLng(lat, lng);
    }

    function getRects() {
        return [
            {
                "id":"bg346dft5",
                "userid": 3333, "rectangle": [
                    [
                        50.47913814989625,
                        30.455131530761722
                    ],
                    [
                        50.50010724740268,
                        30.500450134277347
                    ]
                ], "comment": "хочу чача"
            },
            {
                "id": "feyko563",
                "userid": 4444, "rectangle": [
                    [
                        50.44482488145606,
                        30.57804107666016
                    ],
                    [
                        50.463842315762456,
                        30.608940124511722
                    ]
                ], "comment": "хочу бачача"
            }
        ]
    }
</script>
</body>
</html>
